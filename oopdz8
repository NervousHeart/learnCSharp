using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ConsoleApp5
{
    class Program
    {
        static void Main(string[] args)
        {
            Battlefield battlefield = new Battlefield(5, 5);
            battlefield.ShowInfo();
            Console.ReadKey();

            while (battlefield.CanFight())
            {
                battlefield.Fight();
            }
        }
    }

    class Battlefield
    {
        private Squad _squad1;
        private Squad _squad2;
        private Random _random;

        public Battlefield(int countFightersTeam1, int countFightersTeam2)
        {
            _random = new Random();
            _squad1 = new Squad(countFightersTeam1, _random, "Левая");
            _squad2 = new Squad(countFightersTeam2, _random, "Правая");
        }

        public void ShowInfo()
        {
            _squad1.ShowInfoLeft();
            _squad2.ShowInfoRight(_squad2);
        }

        public bool CanFight()
        {
            if (_squad1.CanFight && _squad2.CanFight)
            {
                return true;
            }
            else
            {
                if (_squad1.CanFight != true)
                {
                    Console.WriteLine("Команда 2 победила!");
                    return false;
                }
                else if (_squad2.CanFight != true)
                {
                    Console.WriteLine("Команда 1 победила!");
                    return false;
                }
                else
                {
                    return true;
                }
            }
        }

        public void Fight()
        {
            Console.Clear();
            ShowInfo();
            Console.WriteLine($"\n\n\n\n\n{_squad1.Name} команда атакует!");
            _squad1.Attack(_squad2);
            _squad2.DeliteCorpse();
            _squad1.DeliteCorpse();
            Console.ReadKey();
            Console.Clear();
            ShowInfo();
            Console.WriteLine($"\n\n\n\n\n{_squad2.Name} команда атакует!");
            _squad2.Attack(_squad1);
            _squad1.DeliteCorpse();
            _squad2.DeliteCorpse();
            Console.ReadKey();
            Console.Clear();
        }

        private void SetCursourRight()
        {
            Console.SetCursorPosition(Console.WindowWidth - 40, 7);
        }

    }

    class Squad
    {
        private int _countFighters;
        private List<Fighter> _fighters;
        private Random _random;

        public string Name { get; private set; }
        public bool CanFight { get; private set; }

        public Squad(int countFighters, Random random, string name)
        {
            _random = random;
            _countFighters = countFighters;
            _fighters = new List<Fighter>();
            CanFight = true;
            Name = name;
            Create();
        }

        public void Attack(Squad squadOpponent)
        {
            if (squadOpponent._fighters.Count > 0 && _fighters.Count > 0)
            {
                for (int i = 0; i < _fighters.Count; i++)
                {
                    int numberTarget = SearchTarget(squadOpponent);
                    if (IsCommanderAlive())
                    {
                        squadOpponent._fighters[numberTarget].GetHit(_fighters[i].TakeDamage() + (_fighters[GetNumberCommander()] as Commander).AuraCommander());
                    }
                    else
                    {
                        squadOpponent._fighters[numberTarget].GetHit(_fighters[i].TakeDamage());
                    }
                }
                    if (IsMedicAlive())
                    {
                        int numberTarget = SearchWounded();
                        (_fighters[GetNumberMedic()] as Medic).Hill(_fighters[numberTarget]);
                    }
            }
            else
            {
                Console.WriteLine("Выживших не осталось.");
                squadOpponent.CanFight = false;
            }
        }


        public void ShowInfoLeft()
        {
            Console.WriteLine("Команда 1: ");
            foreach (var fighter in _fighters)
            {
                fighter.ShowInfo();
            }
        }

        public void ShowInfoRight(Squad squad)
        {
            int left = Console.WindowWidth - 40;
            int top = 0;
            Console.SetCursorPosition(left, top++);
            Console.Write("Команда 2: ");
            for (int i = 0; i < squad._fighters.Count; i++)
            {
                Console.SetCursorPosition(left, top++);
                squad._fighters[i].ShowInfo();
            }
        }

        public void DeliteCorpse()
        {
            for (int i = 0; i < _fighters.Count; i++)
            {
                if (_fighters[i].Health <= 0)
                {
                    _fighters.RemoveAt(i);
                    i--;
                }
            }
        }

        private bool IsCommanderAlive()
        {
            foreach (var fighter in _fighters)
            {
                if (fighter is Commander)
                    return true;
            }
            return false;
        }

        private bool IsMedicAlive()
        {
            {
                foreach (var fighter in _fighters)
                {
                    if (fighter is Medic)
                        return true;
                }
                return false;
            }
        }

        private int GetNumberCommander()
        {
            for (int i = 0; i < _fighters.Count; i++)
            {
                if (_fighters[i] is Commander)
                    return i;
            }
            return 0;
        }

        private int GetNumberMedic()
        {
            {
                for (int i = 0; i < _fighters.Count; i++)
                {
                    if (_fighters[i] is Medic)
                        return i;
                }
                return 0;
            }
        }

        private int SearchTarget(Squad squad)
        {
            int numberTarget = _random.Next(0, squad._fighters.Count);
            return numberTarget;
        }

        private int SearchWounded()
        {
            for (int i = 0; i < _fighters.Count; i++)
            {
                if (_fighters[i].Health<_fighters[i].NativeHealth)
                {
                    return i;
                }
            }
            return 0;
        }

        private void Create()
        {
            _fighters.Add(new Commander(GetName(), _random));
            _fighters.Add(new Medic(GetName(), _random));
            for (int i = 0; i < _countFighters - 2; i++)
            {
                _fighters.Add(new Fighter(GetName(), _random));
            }
        }

        private string GetName()
        {
            int countName = Enum.GetValues(typeof(NameSquad)).Length;
            string name = Convert.ToString((NameSquad)_random.Next(0, countName));
            return name;
        }

    }

    class Fighter
    {
        private int _damage;
        private Random _random;

        public string Name { get; private set; }
        public int Health { get; private set; }
        public int NativeHealth { get; private set; }

        public Fighter(string name, Random random)
        {
            Name = name;
            _random = random;
            _damage = _random.Next(20, 41);
            Health = _random.Next(100, 151);
            NativeHealth = Health;
        }

        public void ShowInfo()
        {
            Console.WriteLine($"{Name}. HP: {Health}/{NativeHealth}. {GetPost()}.");
        }

        public int TakeDamage()
        {
            Console.WriteLine($"\n{Name} стреляет на {_damage} урона.");
            return _damage;
        }

        public void GetHit(int damage)
        {
            Console.WriteLine($"{Name} получил урон {damage}");
            Health -= damage;
        }

        public virtual string GetPost()
        {
            return "Рядовой";
        }

    }

    class Commander : Fighter
    {
        private int _health;
        private int _damageAura;

        public Commander(string name, Random random) : base(name, random)
        {
            _health = random.Next(75, 101);
            _damageAura = random.Next(10, 31);
        }

        public int AuraCommander()
        {
            return _damageAura;
        }

        public override string GetPost()
        {
            return "Командир";
        }

    }

    class Medic : Fighter
    {
        private int _health;
        private int _hillPower;
        public Medic(string name, Random random) : base(name, random)
        {
            _health = random.Next(150, 201);
            _hillPower = random.Next(50, 76);
        }

        public int Hill(Fighter fighter)
        {
            if (fighter.Health + _hillPower > fighter.NativeHealth)
            {
                Console.WriteLine($"Медик лечит {fighter.Name} на {fighter.NativeHealth - fighter.Health}");
                return fighter.NativeHealth - fighter.Health;
            }
            else 
            {
                Console.WriteLine($"Медик лечит {fighter.Name} на {_hillPower}");
                return _hillPower;
            }
        }

        public override string GetPost()
        {
            return "Медик";
        }

    }

    enum NameSquad
    {
        Ivan,
        Boris,
        Sergei,
        Alexei,
        Dmitrii,
        Max,
        Jorj,
        Harry,
        Patrick,
        Alex
    }
}
